//! Contains various tests for `forge test` with precompiles.

use foundry_evm_networks::NetworkConfigs;
use foundry_test_utils::str;

forgetest_init!(precompile_trace_decoding, |prj, cmd| {
    prj.add_test(
        "PrecompileTrace.t.sol",
        r#"
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Test.sol";

contract PrecompileCaller {
    constructor() {
        // 0x01 - ECRECOVER
        {
            bytes32 hash = keccak256("test message");
            uint8 v = 27;
            bytes32 r = bytes32(uint256(1));
            bytes32 s = bytes32(uint256(2));
            address(0x01).staticcall(abi.encode(hash, v, r, s));
        }

        // 0x02 - SHA256
        address(0x02).staticcall(abi.encodePacked("hello"));

        // 0x03 - RIPEMD160
        address(0x03).staticcall(abi.encodePacked("hello"));

        // 0x04 - IDENTITY (datacopy)
        address(0x04).staticcall(abi.encodePacked("hello"));

        // 0x05 - MODEXP: compute 2^3 mod 5 = 3
        {
            bytes memory modexpInput = abi.encodePacked(
                uint256(1),  // base length
                uint256(1),  // exponent length
                uint256(1),  // modulus length
                uint8(2),    // base = 2
                uint8(3),    // exponent = 3
                uint8(5)     // modulus = 5
            );
            address(0x05).staticcall(modexpInput);
        }

        // 0x06 - BN254 ADD (ecadd): P + O = P
        {
            uint256 g1x = 1;
            uint256 g1y = 2;
            uint256 zerox = 0;
            uint256 zeroy = 0;
            address(0x06).staticcall(abi.encode(g1x, g1y, zerox, zeroy));
        }

        // 0x07 - BN254 MUL (ecmul): 1 * G = G
        {
            uint256 g1x = 1;
            uint256 g1y = 2;
            uint256 scalar = 1;
            address(0x07).staticcall(abi.encode(g1x, g1y, scalar));
        }

        // 0x08 - BN254 PAIRING: empty input returns success (1)
        address(0x08).staticcall("");

        // 0x09 - BLAKE2F
        {
            bytes memory blake2fInput = new bytes(213);
            blake2fInput[3] = 0x0c; // 12 rounds
            bytes8[8] memory iv = [
                bytes8(0x6a09e667f3bcc908),
                bytes8(0xbb67ae8584caa73b),
                bytes8(0x3c6ef372fe94f82b),
                bytes8(0xa54ff53a5f1d36f1),
                bytes8(0x510e527fade682d1),
                bytes8(0x9b05688c2b3e6c1f),
                bytes8(0x1f83d9abfb41bd6b),
                bytes8(0x5be0cd19137e2179)
            ];
            for (uint256 i = 0; i < 8; i++) {
                for (uint256 j = 0; j < 8; j++) {
                    blake2fInput[4 + i * 8 + j] = iv[i][j];
                }
            }
            blake2fInput[212] = 0x01;
            address(0x09).staticcall(blake2fInput);
        }

        // 0x0B - BLS12-381 G1 ADD (two points at infinity)
        address(0x0B).staticcall(new bytes(256));

        // 0x0C - BLS12-381 G1 MSM
        address(0x0C).staticcall(new bytes(160));

        // 0x0D - BLS12-381 G2 ADD (two points at infinity)
        address(0x0D).staticcall(new bytes(512));

        // 0x0E - BLS12-381 G2 MSM
        address(0x0E).staticcall(new bytes(288));

        // 0x0F - BLS12-381 PAIRING (G1 + G2 infinity points)
        address(0x0F).staticcall(new bytes(384));

        // 0x10 - BLS12-381 MAP FP TO G1
        address(0x10).staticcall(new bytes(64));

        // 0x11 - BLS12-381 MAP FP2 TO G2
        address(0x11).staticcall(new bytes(128));

        // 0x100 - P256VERIFY (secp256r1)
        address(0x100).staticcall(new bytes(160));
    }
}

contract PrecompileTraceTest is Test {
    function test_precompile_traces() public {
        new PrecompileCaller();
    }
}
   "#,
    );

    cmd.args(["test", "--mt", "test_precompile_traces", "-vvvv", "--evm-version", "osaka"])
        .assert_success()
        .stdout_eq(str![[r#"
[COMPILING_FILES] with [SOLC_VERSION]
[SOLC_VERSION] [ELAPSED]
Compiler run successful!

Ran 1 test for test/PrecompileTrace.t.sol:PrecompileTraceTest
[PASS] test_precompile_traces() ([GAS])
Traces:
  [775925] PrecompileTraceTest::test_precompile_traces()
    ├─ [763039] → new PrecompileCaller@0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f
    │   ├─ [3000] ECRecover::ecrecover(0xf2d81a81793fda00e28dddd4cc26d2ac7e506543c7e7f47aa022de7dc4d44348, 27, 1, 2) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [108] SHA-256::sha256(0x68656c6c6f) [staticcall]
    │   │   └─ ← [Return] 0x2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824
    │   ├─ [600] RIPEMD-160::ripemd(0x68656c6c6f) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000108f07b8382412612c048d07d13f814118445acd
    │   ├─ [15] Identity::identity(0x68656c6c6f) [staticcall]
    │   │   └─ ← [Return] 0x68656c6c6f
    │   ├─ [31] ModExp::modexp(1, 1, 1, 0x02, 0x03, 0x05) [staticcall]
    │   │   └─ ← [Return] 0x03
    │   ├─ [150] ECAdd::ecadd(1, 2, 0, 0) [staticcall]
    │   │   └─ ← [Return] 1, 2
    │   ├─ [6000] ECMul::ecmul(1, 2, 1) [staticcall]
    │   │   └─ ← [Return] 1, 2
    │   ├─ [45000] ECPairing::ecpairing() [staticcall]
    │   │   └─ ← [Return] true
    │   ├─ [12] Blake2F::blake2f(12, [7640891576956012808, 13503953896175478587, 4354685564936845355, 11912009170470909681, 5840696475078001361, 11170449401992604703, 2270897969802886507, 6620516959819538809], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0], 1) [staticcall]
    │   │   └─ ← [Return] 0x0d4d1c983fa580ba
    │   ├─ [375] BLS12_G1ADD::bls12G1Add(0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, 0x) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [12275] BLS12_G1MSM::bls12G1Msm(0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) [staticcall]
    │   │   └─ ← [Return] 0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [600] BLS12_G2ADD::bls12G2Add(0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, 0x) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [55000] BLS12_G2MSM::bls12G2Msm(0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) [staticcall]
    │   │   └─ ← [Return] 0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    │   ├─ [37700] BLS12_PAIRING_CHECK::bls12PairingCheck(0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) [staticcall]
    │   │   └─ ← [Return] true
    │   ├─ [5500] BLS12_MAP_FP_TO_G1::bls12MapFpToG1(0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) [staticcall]
    │   │   └─ ← [Revert] EvmError: Revert
    │   ├─ [23800] BLS12_MAP_FP2_TO_G2::bls12MapFp2ToG2(0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000) [staticcall]
    │   │   └─ ← [Revert] EvmError: Revert
    │   ├─ [6900] P256VERIFY::p256Verify(0x0000000000000000000000000000000000000000000000000000000000000000, 0, 0, 0, 0) [staticcall]
    │   │   └─ ← [Return] 0x
    │   └─ ← [Return] 610 bytes of code
    └─ ← [Return]

Suite result: ok. 1 passed; 0 failed; 0 skipped; [ELAPSED]

Ran 1 test suite [ELAPSED]: 1 tests passed, 0 failed, 0 skipped (1 total tests)

"#]]);
});

// tests transfer using celo precompile.
// <https://github.com/foundry-rs/foundry/issues/11622>
forgetest_init!(celo_transfer, |prj, cmd| {
    prj.update_config(|config| {
        config.networks = NetworkConfigs::with_celo();
    });

    prj.add_test(
        "CeloTransfer.t.sol",
        r#"
import "forge-std/Test.sol";

interface IERC20 {
    function balanceOf(address account) external view returns (uint256);
    function transfer(address to, uint256 amount) external returns (bool);
}

contract CeloTransferTest is Test {
    IERC20 celo = IERC20(0x471EcE3750Da237f93B8E339c536989b8978a438);
    IERC20 usdc = IERC20(0xcebA9300f2b948710d2653dD7B07f33A8B32118C);
    IERC20 usdt = IERC20(0x48065fbBE25f71C9282ddf5e1cD6D6A887483D5e);

    address binanceAccount = 0xf6436829Cf96EA0f8BC49d300c536FCC4f84C4ED;
    address recipient = makeAddr("recipient");

    function setUp() public {
        vm.createSelectFork("https://forno.celo.org");
    }

    function testCeloBalance() external {
        console2.log("recipient balance before", celo.balanceOf(recipient));
        vm.prank(binanceAccount);
        celo.transfer(recipient, 100);
        console2.log("recipient balance after", celo.balanceOf(recipient));
        assertEq(celo.balanceOf(recipient), 100);
    }
}
   "#,
    );

    cmd.args(["test", "--mt", "testCeloBalance", "-vvv"]).assert_success().stdout_eq(str![[r#"
[COMPILING_FILES] with [SOLC_VERSION]
[SOLC_VERSION] [ELAPSED]
Compiler run successful!

Ran 1 test for test/CeloTransfer.t.sol:CeloTransferTest
[PASS] testCeloBalance() ([GAS])
Logs:
  recipient balance before 0
  recipient balance after 100

Suite result: ok. 1 passed; 0 failed; 0 skipped; [ELAPSED]

Ran 1 test suite [ELAPSED]: 1 tests passed, 0 failed, 0 skipped (1 total tests)

"#]]);
});
